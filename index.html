<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×™×“×¢ ×›×œ×œ×™ â€¢ 500 â€¢ Light â€¢ Mastery+Spaced+Confidence</title>
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.12);
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --accent:#2563eb;      /* blue */
      --accent2:#06b6d4;     /* cyan */
      --good:#16a34a;
      --bad:#e11d48;
      --warn:#d97706;
      --ringbg:rgba(15,23,42,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Hebrew",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 85% -10%, rgba(37,99,235,.14), transparent 55%),
        radial-gradient(900px 600px at 10% 0%, rgba(6,182,212,.12), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px 14px 12px;
      display:flex;gap:12px;justify-content:space-between;align-items:flex-start;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4}
    .pillrow{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-start}
    .pill{
      background:rgba(37,99,235,.06);
      border:1px solid rgba(37,99,235,.18);
      color:var(--muted);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      display:inline-flex;gap:6px;align-items:center;
      white-space:nowrap;
    }
    .pill b{color:var(--ink);font-weight:900}
    main{margin-top:14px;display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:900px){main{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row.space{justify-content:space-between;align-items:flex-start}
    button{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      font-size:14px;
      box-shadow:0 4px 10px rgba(15,23,42,.06);
    }
    button:hover{border-color:rgba(37,99,235,.35)}
    button.primary{
      background:linear-gradient(180deg, rgba(37,99,235,.12), rgba(37,99,235,.06));
      border-color:rgba(37,99,235,.35);
    }
    button.good{
      background:linear-gradient(180deg, rgba(22,163,74,.12), rgba(22,163,74,.06));
      border-color:rgba(22,163,74,.35);
    }
    button.bad{
      background:linear-gradient(180deg, rgba(225,29,72,.10), rgba(225,29,72,.05));
      border-color:rgba(225,29,72,.28);
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .meta{color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap}
    .tag{
      background:rgba(2,6,23,.03);
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 9px;
      font-size:12px;
      color:var(--muted);
      display:inline-flex;gap:6px;align-items:center;
    }
    .qtext{font-size:17px;line-height:1.55;margin:10px 0 10px}
    .answers{display:grid;gap:10px;margin-top:10px}
    .ans{
      text-align:right;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(2,6,23,.02);
      cursor:pointer;
      display:flex;gap:10px;align-items:flex-start;
    }
    .ans:hover{border-color:rgba(37,99,235,.30);background:rgba(37,99,235,.03)}
    .ans .key{
      width:26px;height:26px;border-radius:9px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--line);
      color:var(--muted);
      font-weight:900;
      flex:0 0 auto;
      background:#fff;
    }
    .ans .label{flex:1}
    .ans.correct{border-color:rgba(22,163,74,.45);background:rgba(22,163,74,.06)}
    .ans.wrong{border-color:rgba(225,29,72,.40);background:rgba(225,29,72,.05)}
    .box{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(2,6,23,.02);
      line-height:1.55;
      color:var(--ink);
    }
    .small{color:var(--muted);font-size:12px;line-height:1.45}
    .progress{height:10px;border-radius:999px;border:1px solid var(--line);overflow:hidden;background:#fff}
    .bar{height:100%;width:0%;background:linear-gradient(90deg, var(--accent), var(--accent2))}
    .statgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .stat{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(2,6,23,.02);
    }
    .stat .k{color:var(--muted);font-size:12px}
    .stat .v{font-size:18px;font-weight:900;margin-top:2px}
    canvas{width:100%;height:auto;border-radius:14px;border:1px solid var(--line);background:#fff}
    .toast{
      position:fixed;bottom:14px;left:14px;right:14px;max-width:980px;margin:0 auto;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.92);box-shadow:var(--shadow);
      display:none;color:var(--ink)
    }
    .meters{display:grid;grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width:900px){.meters{grid-template-columns:1fr}}
    .meterCard{border:1px solid var(--line);border-radius:16px;background:rgba(2,6,23,.02);padding:10px}
    .meterTitle{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .meterTitle b{font-size:13px}
    .meterTitle span{font-size:12px;color:var(--muted)}
    .badgeRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .badge{
      display:inline-flex;gap:8px;align-items:center;
      border:1px solid var(--line);background:#fff;
      border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(37,99,235,.28);border:1px solid rgba(37,99,235,.22)}
    .bname{color:var(--ink);font-weight:900}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .choiceRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .chip.on{
      border-color:rgba(37,99,235,.35);
      background:rgba(37,99,235,.06);
      color:var(--ink);
      font-weight:900;
    }
    .confBtns{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .confBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
    }
    .confBtn.on{
      border-color:rgba(6,182,212,.45);
      background:rgba(6,182,212,.10);
      color:var(--ink);
      font-weight:900;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div style="flex:1">
      <h1>×™×“×¢ ×›×œ×œ×™ â€¢ 500 ×©××œ×•×ª â€¢ ×’×¨×¡×” ×‘×”×™×¨×” â€¢ Mastery + Spaced + Confidence</h1>
      <div class="sub">
        ×œ××™×“×” ××‘×•×¡×¡×ª: ×©×œ×™×¤×” (Quiz), ×—×–×¨×•×ª ××¨×•×•×—×•×ª (Spaced), ×“×™×¨×•×’ ×‘×™×˜×—×•×Ÿ (Confidence), ×”×“×¨×’×ª×™×•×ª ×§×©×™×—×” ×œ×›×œ × ×•×©× (Topic Mastery),
        ×¢×¨×‘×•×‘ ×—×›× (Interleaving), ×•×ª×™×§×•×Ÿ ××™×™×“×™ ××—×¨×™ ×˜×¢×•×ª (Micro-Retest).
      </div>
    </div>
    <div class="pillrow">
      <div class="pill">Overall: <b id="overallPill">â€”</b></div>
      <div class="pill">×“×™×•×§: <b id="accPill">â€”</b></div>
      <div class="pill">× ×¢× ×•: <b id="answeredPill">0</b></div>
      <div class="pill">××¡×•×›×Ÿ: <b id="dangerPill">0</b></div>
      <div class="pill">×—×–×¨×•×ª: <b id="reviewPill">0</b></div>
      <div class="pill">×××’×¨: <b>500</b></div>
    </div>
  </header>

  <main>
    <section class="card">
      <div id="screen_intro">
        <div class="row space">
          <div>
            <div class="qtext" style="margin:0">×”×ª×—×œ×”</div>
            <div class="small">
              ×œ×¤×ª×•×— ×‘×“×¤×“×¤×Ÿ (Chrome). ××§×©×™×: 1â€“4 ×œ×‘×—×™×¨×”, N ×œ×©××œ×” ×”×‘××”.
            </div>

            <div class="box small" style="margin-top:10px">
              <b>××¦×‘×™ ×œ××™×“×”:</b><br>
              â€¢ <b>Mix</b>: ×¢×¨×‘×•×‘ ×—×›× ×‘×™×Ÿ × ×•×©××™× (Interleaving).<br>
              â€¢ <b>Focus</b>: ×œ×”×ª××§×“ ×‘× ×•×©××™× ×©×ª×‘×—×¨.<br><br>
              <b>Mastery:</b> ×œ×›×œ × ×•×©× ×¨××” 1â€“5. ×”×¨××” ×¢×•×œ×” ×¨×§ ×¢× ×¨×¦×£ ×”×¦×œ×—×•×ª + ×“×™×•×§ ××™× ×™××œ×™ + XP ×‘×ª×—×•×.
            </div>

            <div class="divider"></div>

            <div class="small"><b>×‘×—×™×¨×ª ××¦×‘</b></div>
            <div class="choiceRow">
              <div class="chip on" id="modeMix">Mix (××•××œ×¥)</div>
              <div class="chip" id="modeFocus">Focus</div>
              <div class="chip" id="modeDaily">Daily 10</div>
            </div>

            <div id="topicChooser" style="display:none;margin-top:8px">
              <div class="small"><b>×‘×—×¨ × ×•×©××™× ×œ×¤×•×§×•×¡</b></div>
              <div class="choiceRow" id="topicChips"></div>
            </div>

            <div class="box small" style="margin-top:10px">
              <b>××” ×—×“×© ×‘×‘×•×—×Ÿ:</b> ××—×¨×™ ×ª×©×•×‘×” ×ª×“×¨×’ ×‘×™×˜×—×•×Ÿ (1â€“3). ×× ×˜×¢×™×ª ×‘×‘×™×˜×—×•×Ÿ ×’×‘×•×”â€”×”××¢×¨×›×ª ×ª×™×ª×Ÿ ×œ×–×” ×¢×“×™×¤×•×ª ×‘×—×–×¨×•×ª (×–×” "××–×•×¨ ×¡×™×›×•×Ÿ").
            </div>
          </div>

          <div class="row">
            <button class="primary" id="startBtn">×”×ª×—×™×œ×™</button>
            <button id="resetBtn" class="bad">××™×¤×•×¡</button>
          </div>
        </div>
      </div>

      <div id="screen_quiz" style="display:none">
        <div class="row space">
          <div>
            <div class="meta" id="qMeta"></div>
            <div class="qtext" id="qText">â€”</div>
          </div>
          <div class="row">
            <button id="skipBtn">×“×œ×’×™</button>
          </div>
        </div>

        <div class="meters">
          <div class="meterCard">
            <div class="meterTitle"><b>××“ ×¢×’×•×œ: Overall</b><span id="overallLabel">â€”</span></div>
            <canvas id="meterOverall" width="900" height="260"></canvas>
            <div class="small">××©×§×œ×•×œ: ×“×™×•×§ + ×¢×•××§ ×ª×¨×’×•×œ (×›××” × ×¢× ×•). ×œ× ××©×•×ª×£ ×‘×™×Ÿ ××©×ª××©×™×.</div>
          </div>
          <div class="meterCard">
            <div class="meterTitle"><b>××“ ×¢×’×•×œ: ×”× ×•×©× ×”× ×•×›×—×™</b><span id="topicLabel">â€”</span></div>
            <canvas id="meterTopic" width="900" height="260"></canvas>
            <div class="small">××‘×•×¡×¡ ×¢×œ ×‘×™×¦×•×¢×™× ×‘×ª×•×š ×”× ×•×©× ×‘×œ×‘×“ + ××™× ×™××•× × ×™×¡×™×•× ×•×ª (Mastery).</div>
          </div>
        </div>

        <div class="progress" style="margin:10px 0 8px"><div class="bar" id="xpBar"></div></div>
        <div class="small" id="xpText">×”×ª×§×“××•×ª ×‘× ×•×©×: â€”</div>

        <div class="answers" id="answers"></div>

        <div class="box" id="feedbackBox" style="display:none">
          <div id="feedbackText"></div>

          <div class="divider"></div>

          <div class="small"><b>×›××” ×”×™×™×ª ×‘×˜×•×—×” ×‘×ª×©×•×‘×”?</b> (Confidence)</div>
          <div class="confBtns">
            <div class="confBtn" data-c="1">1 â€” ×œ× ×‘×˜×•×—×”</div>
            <div class="confBtn" data-c="2">2 â€” ×“×™ ×‘×˜×•×—×”</div>
            <div class="confBtn" data-c="3">3 â€” ×‘×˜×•×—×” ×××•×“</div>
          </div>
          <div class="small" id="confHint" style="margin-top:6px"></div>

          <div class="row" style="margin-top:10px">
            <button class="good" id="nextBtn">×©××œ×” ×”×‘××”</button>
            <button id="flagBtn">×¡×× ×™ ×œ×—×–×¨×”</button>
            <button id="whyBtn">×œ××” ×”×©××¨ ×©×’×•×™?</button>
          </div>

          <div id="whyBox" class="box small" style="display:none;margin-top:10px"></div>
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="row space">
        <div>
          <div class="qtext" style="margin:0">×›×¨×˜×™×¡ ×™×“×¢</div>
          <div class="small">×¨×“××¨ ×œ×¤×™ ×ª×—×•××™×, ×“×¨×’×•×ª, â€œ××–×•×¨ ×¡×™×›×•×Ÿâ€, ×•×©××™×¨×ª PNG.</div>
        </div>
        <div class="row">
          <button id="savePngBtn">×©××•×¨ ×›×¨×˜×™×¡ (PNG)</button>
          <button id="copyStatsBtn">×”×¢×ª×§ ×“×•×—</button>
        </div>
      </div>

      <div class="statgrid">
        <div class="stat"><div class="k">× ×¢× ×•</div><div class="v" id="answeredStat">0</div></div>
        <div class="stat"><div class="k">× ×›×•×Ÿ</div><div class="v" id="correctStat">0</div></div>
        <div class="stat"><div class="k">××–×•×¨ ×¡×™×›×•×Ÿ</div><div class="v" id="dangerStat">0</div></div>
        <div class="stat"><div class="k">×¨××” ×‘× ×•×©× × ×•×›×—×™</div><div class="v" id="topicLvlStat">â€”</div></div>
      </div>

      <div class="box" style="margin-top:10px">
        <div class="small"><b>×˜×‘×¢×ª Overall + ×¡×˜×˜×•×¡</b></div>
        <canvas id="donut" width="900" height="280"></canvas>

        <div class="divider"></div>

        <div class="small"><b>×¨×“××¨ ×™×“×¢ ×œ×¤×™ ×ª×—×•××™×</b></div>
        <canvas id="radar" width="900" height="560"></canvas>

        <div class="divider"></div>

        <div class="small"><b>×“×¨×’×•×ª ×œ×¤×™ ×ª×—×•× (Mastery)</b></div>
        <div id="badges" class="badgeRow"></div>

        <div class="divider"></div>

        <div class="small"><b>×—×–×§×•×ª / ×—×œ×©×•×ª</b></div>
        <div id="strengthWeak" class="small" style="margin-top:6px"></div>
      </div>

      <div class="box small mono" style="margin-top:10px">
        Version: <span id="verBox"></span> â€¢ Seed: <span id="seedBox"></span>
      </div>
    </aside>
  </main>

  <div class="toast" id="toast"></div>
</div>

<script>
/* =========================================================
   CONFIG
========================================================= */
const LS_KEY="gk500_light_mastery_v1";
const VERSION="2025-12-19-light-mastery";
const SEED=222905;

document.getElementById("verBox").textContent = VERSION;
document.getElementById("seedBox").textContent = String(SEED);

const TOPICS=[
  "×”×™×¡×˜×•×¨×™×”","××™×©×™×","×¤×•×œ×™×˜×™×§×” ×•××“×™× ×”","×¦×‘× ×•×‘×™×˜×—×•×Ÿ","×›×œ×›×œ×”","××“×¢",
  "×’×™××•×’×¨×¤×™×”","×ª×¨×‘×•×ª ×•××•×× ×•×ª","×¡×¤×¨×•×ª","×˜×›× ×•×œ×•×’×™×”","×¡×‘×™×‘×”","×¡×¤×•×¨×˜"
];

const BLOOM = ["×–×™×›×¨×•×Ÿ","×”×‘× ×”","×™×™×©×•×","× ×™×ª×•×—"]; // kept compact for UI

/* =========================================================
   Utils
========================================================= */
function $(id){return document.getElementById(id)}
function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
function now(){return Date.now()}
function fmtPct(x){return (x==null)?"â€”":Math.round(x*100)+"%"}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function toast(msg){const el=$("toast"); el.textContent=msg; el.style.display="block"; clearTimeout(toast._t); toast._t=setTimeout(()=>el.style.display="none",1800)}
function loadState(){try{const r=localStorage.getItem(LS_KEY); return r?JSON.parse(r):null}catch(e){return null}}
function saveState(){localStorage.setItem(LS_KEY, JSON.stringify(state))}
function hardReset(){localStorage.removeItem(LS_KEY); location.reload()}

function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function shuffle(rng, arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(rng()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }

/* =========================================================
   Concepts (compact, generated to 500 questions deterministically)
   Each question includes:
   - topic, difficulty 1..5 (content difficulty)
   - bloom level
   - conceptTerm (anchor), so we can do micro-retest
========================================================= */
const CONCEPTS = [
  {topic:"×¤×•×œ×™×˜×™×§×” ×•××“×™× ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:1, term:"×“××•×§×¨×˜×™×” ×™×™×¦×•×’×™×ª", def:"×©×™×˜×” ×©×‘×” ×”×¦×™×‘×•×¨ ×‘×•×—×¨ × ×¦×™×’×™× ×©××§×‘×œ×™× ×”×—×œ×˜×•×ª ×‘×©××•."},
  {topic:"×¤×•×œ×™×˜×™×§×” ×•××“×™× ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"×”×¤×¨×“×ª ×¨×©×•×™×•×ª", def:"×—×œ×•×§×ª ×¡××›×•×™×•×ª ×‘×™×Ÿ ××—×•×§×§×ª, ××‘×¦×¢×ª ×•×©×•×¤×˜×ª ×›×“×™ ×œ×¦××¦× ×¨×™×›×•×– ×›×•×—."},
  {topic:"×¤×•×œ×™×˜×™×§×” ×•××“×™× ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"××™×–×•× ×™× ×•×‘×œ××™×", def:"×× ×’× ×•× ×™× ×©×××¤×©×¨×™× ×œ×¨×©×•×™×•×ª ×œ×¤×§×— ×–×• ×¢×œ ×–×• ×•×œ×”×’×‘×™×œ ×©×™××•×© ×œ×¨×¢×” ×‘×›×•×—."},
  {topic:"×¤×•×œ×™×˜×™×§×” ×•××“×™× ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"×©×œ×˜×•×Ÿ ×”×—×•×§", def:"×¢×™×§×¨×•×Ÿ ×©×œ×¤×™×• ×’× ×”×©×œ×˜×•×Ÿ ×›×¤×•×£ ×œ×—×•×§ ×•×›×œ×œ×™× ×›×œ×œ×™×™× ×•×œ× ×œ×©×¨×™×¨×•×ª."},
  {topic:"×¤×•×œ×™×˜×™×§×” ×•××“×™× ×”", region:"×¢×•×œ×", diff:3, term:"×¤×“×¨×œ×™×–×", def:"××‘× ×” ××“×™× ×™ ×”××—×œ×§ ×¡××›×•×™×•×ª ×‘×™×Ÿ ×××©×œ ××¨×›×–×™ ×œ×™×—×™×“×•×ª ××–×•×¨×™×•×ª (××“×™× ×•×ª/××—×•×–×•×ª)."},
  {topic:"×¤×•×œ×™×˜×™×§×” ×•××“×™× ×”", region:"×¢×•×œ×", diff:3, term:"×¤×•×¤×•×œ×™×–×", def:"×¡×’× ×•×Ÿ ×¤×•×œ×™×˜×™ ×©××“×’×™×© ×¢×™××•×ª '×”×¢×' ××•×œ '××œ×™×˜×•×ª' ×•×œ×¢×™×ª×™× ××¦×™×¢ ×¤×ª×¨×•× ×•×ª ×¤×©×•×˜×™× ×œ×‘×¢×™×•×ª ××•×¨×›×‘×•×ª."},
  {topic:"×¤×•×œ×™×˜×™×§×” ×•××“×™× ×”", region:"×¢×•×œ×", diff:4, term:"×’'×¨×™×× ×“×¨×™× ×’", def:"×©×¨×˜×•×˜ ×’×‘×•×œ×•×ª ××—×•×–×•×ª ×‘×—×™×¨×” ×‘××•×¤×Ÿ ×©××™×˜×™×‘ ×¤×•×œ×™×˜×™×ª ×¢× ×¦×“ ××¡×•×™×."},

  {topic:"×›×œ×›×œ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:1, term:"××™× ×¤×œ×¦×™×”", def:"×¢×œ×™×™×” ×›×œ×œ×™×ª ×•××ª××©×›×ª ×‘××—×™×¨×™× ×©××¤×—×™×ª×” ××ª ×›×•×— ×”×§× ×™×™×”."},
  {topic:"×›×œ×›×œ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"×“×¤×œ×¦×™×”", def:"×™×¨×™×“×” ×›×œ×œ×™×ª ×•××ª××©×›×ª ×‘××—×™×¨×™× (×œ×¢×™×ª×™× ××œ×•×•×” ×‘×™×¨×™×“×” ×‘×‘×™×§×•×©)."},
  {topic:"×›×œ×›×œ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"GDP (×ª×•×¦×¨ ××§×•××™ ×’×•×œ××™)", def:"××“×“ ×œ×¢×¨×š ×”×›×•×œ×œ ×©×œ ×¡×—×•×¨×•×ª ×•×©×™×¨×•×ª×™× ×©×™×•×¦×¨×• ×‘×›×œ×›×œ×” ×‘×–××Ÿ × ×ª×•×Ÿ."},
  {topic:"×›×œ×›×œ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"××“×™× ×™×•×ª ×¤×™×¡×§×œ×™×ª", def:"×©×™××•×© ×‘×ª×§×¦×™×‘ ×”××“×™× ×”: ××™×¡×™× ×•×”×•×¦××•×ª ×›×“×™ ×œ×”×©×¤×™×¢ ×¢×œ ×”×›×œ×›×œ×”."},
  {topic:"×›×œ×›×œ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"××“×™× ×™×•×ª ××•× ×™×˜×¨×™×ª", def:"×©×™××•×© ×‘×›×œ×™× ×›××• ×¨×™×‘×™×ª ×•×”×™×¦×¢ ×›×¡×£ (×‘× ×§ ××¨×›×–×™) ×›×“×™ ×œ×”×©×¤×™×¢ ×¢×œ ××™× ×¤×œ×¦×™×” ×•×¦××™×—×”."},
  {topic:"×›×œ×›×œ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:3, term:"×™×ª×¨×•×Ÿ ×™×—×¡×™", def:"×™×›×•×œ×ª ×œ×™×™×¦×¨ ××•×¦×¨ ×‘×¢×œ×•×ª ××œ×˜×¨× ×˜×™×‘×™×ª × ××•×›×” ×™×—×¡×™×ª ×œ××—×¨×™×, ×‘×¡×™×¡ ×œ×¡×—×¨."},
  {topic:"×›×œ×›×œ×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:4, term:"×¢×œ×•×ª ××œ×˜×¨× ×˜×™×‘×™×ª", def:"××” ×©××•×•×ª×¨×™× ×¢×œ×™×• ×›×©×‘×•×—×¨×™× ××¤×©×¨×•×ª ××—×ª ×‘××§×•× ××—×¨×ª."},

  {topic:"××“×¢", region:"×™×©×¨××œ+×¢×•×œ×", diff:1, term:"DNA", def:"××•×œ×§×•×œ×” ×©× ×•×©××ª ××™×“×¢ ×’× ×˜×™ ×‘×ª××™×."},
  {topic:"××“×¢", region:"×™×©×¨××œ+×¢×•×œ×", diff:1, term:"×•×™×¨×•×¡", def:"×’×•×¨× ×–×™×”×•××™ ×©×–×§×•×§ ×œ×ª× ×××¨×— ×›×“×™ ×œ×”×©×ª×›×¤×œ."},
  {topic:"××“×¢", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"×”×©×¢×¨×”", def:"×˜×¢× ×”/× ×™×‘×•×™ ×©× ×™×ª×Ÿ ×œ×‘×“×•×§ ×‘× ×™×¡×•×™ ××• ×ª×¦×¤×™×ª."},
  {topic:"××“×¢", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"×ª×™××•×¨×™×” ××“×¢×™×ª", def:"××¡×’×¨×ª ×”×¡×‘×¨ ××‘×•×¡×¡×ª ×¨××™×•×ª ×¨×‘×•×ª ×©××¡×•×’×œ×ª ×œ× ×‘× ×ª×•×¦××•×ª."},
  {topic:"××“×¢", region:"×™×©×¨××œ+×¢×•×œ×", diff:3, term:"× ×™×¡×•×™ ××‘×•×§×¨", def:"× ×™×¡×•×™ ×¢× ×ª× ××™× × ×©×œ×˜×™× ×•×§×‘×•×¦×ª ×‘×™×§×•×¨×ª ×œ×”×©×•×•××”."},
  {topic:"××“×¢", region:"×™×©×¨××œ+×¢×•×œ×", diff:4, term:"×× ×˜×¨×•×¤×™×”", def:"××“×“ ×œ××™-×¡×“×¨/××¡×¤×¨ ××¦×‘×™× ××¤×©×¨×™×™× ×‘××¢×¨×›×ª (×‘×”×§×©×¨ ×ª×¨××•×“×™× ××™)."},

  {topic:"×˜×›× ×•×œ×•×’×™×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:1, term:"××œ×’×•×¨×™×ª×", def:"×¡×˜ ×¦×¢×“×™×/×›×œ×œ×™× ×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×” ××• ×‘×™×¦×•×¢ ××©×™××”."},
  {topic:"×˜×›× ×•×œ×•×’×™×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"×”×¦×¤× ×”", def:"×”××¨×ª ××™×“×¢ ×œ×¦×•×¨×” ×©×œ× × ×™×ª×Ÿ ×œ×§×¨×•× ×‘×œ×™ ××¤×ª×— ××ª××™×."},
  {topic:"×˜×›× ×•×œ×•×’×™×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"×¤×™×©×™× ×’", def:"×”×ª×—×–×•×ª ×›×“×™ ×œ×’×¨×•× ×œ××©×ª××© ×œ××¡×•×¨ ×¡×™×¡××”/××™×“×¢ ×¨×’×™×©."},
  {topic:"×˜×›× ×•×œ×•×’×™×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:3, term:"××™××•×ª ×“×•-×©×œ×‘×™ (2FA)", def:"××‘×˜×—×” ×©××•×¡×™×¤×” ×©×›×‘×ª ××™××•×ª × ×•×¡×¤×ª ××¢×‘×¨ ×œ×¡×™×¡××”."},
  {topic:"×˜×›× ×•×œ×•×’×™×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:4, term:"×œ××™×“×ª ××›×•× ×”", def:"×©×™×˜×•×ª ×©×‘×”×Ÿ ××•×“×œ×™× ×œ×•××“×™× ×“×¤×•×¡×™× ×× ×ª×•× ×™× ×›×“×™ ×œ×—×–×•×ª/×œ×¡×•×•×’."},

  {topic:"×¦×‘× ×•×‘×™×˜×—×•×Ÿ", region:"×™×©×¨××œ+×¢×•×œ×", diff:1, term:"×”×¨×ª×¢×”", def:"×œ×’×¨×•× ×œ×™×¨×™×‘ ×œ×”×™×× ×¢ ××¤×¢×•×œ×” ×‘×’×œ×œ ×¢×œ×•×ª/×¡×™×›×•×Ÿ ×¦×¤×•×™×™×."},
  {topic:"×¦×‘× ×•×‘×™×˜×—×•×Ÿ", region:"×™×©×¨××œ+×¢×•×œ×", diff:1, term:"××•×“×™×¢×™×Ÿ", def:"××™×¡×•×£ ×•× ×™×ª×•×— ××™×“×¢ ×œ×”×¤×—×ª×ª ××™-×•×“××•×ª ×•×ª××™×›×” ×‘×”×—×œ×˜×•×ª."},
  {topic:"×¦×‘× ×•×‘×™×˜×—×•×Ÿ", region:"×™×©×¨××œ+×¢×•×œ×", diff:3, term:"××œ×—××” ×”×™×‘×¨×™×“×™×ª", def:"×©×™×œ×•×‘ ×××¦×¢×™× ×¦×‘××™×™× ×•×œ×-×¦×‘××™×™× (×¡×™×™×‘×¨, ×ª×•×“×¢×”, ×›×œ×›×œ×”) ×‘××¢×¨×›×” ××—×ª."},
  {topic:"×¦×‘× ×•×‘×™×˜×—×•×Ÿ", region:"×™×©×¨××œ+×¢×•×œ×", diff:4, term:"×¡×™×™×‘×¨", def:"×ª×—×•× ×”×ª×§×™×¤×”/×”×’× ×” ×‘××¢×¨×›×•×ª ××—×©×•×‘, ×¨×©×ª×•×ª ×•× ×ª×•× ×™×."},

  {topic:"×’×™××•×’×¨×¤×™×”", region:"×¢×•×œ×", diff:1, term:"×§×• ×”××©×•×•×”", def:"×§×• ×¨×•×—×‘ 0Â° ×©××—×œ×§ ××ª ×”×¢×•×œ× ×œ×¦×¤×•×Ÿ ×•×œ×“×¨×•×."},
  {topic:"×’×™××•×’×¨×¤×™×”", region:"×¢×•×œ×", diff:2, term:"××§×œ×™×", def:"×“×¤×•×¡ ××–×’ ××•×•×™×¨ ××¨×•×š ×˜×•×•×— ×‘××–×•×¨ ××¡×•×™×."},

  {topic:"×¡×‘×™×‘×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"×§×™×™××•×ª", def:"×©×™××•×© ×‘××©××‘×™× ×‘××•×¤×Ÿ ×©××™× ×• ×¤×•×’×¢ ×‘×™×›×•×œ×ª ×”×“×•×¨×•×ª ×”×‘××™× ×œ×—×™×•×ª ×•×œ×©×’×©×’."},
  {topic:"×¡×‘×™×‘×”", region:"×™×©×¨××œ+×¢×•×œ×", diff:3, term:"××¤×§×˜ ×—×××”", def:"×ª×”×œ×™×š ×©×‘×• ×’×–×™× ×‘××˜××•×¡×¤×¨×” ×œ×•×›×“×™× ×—×•× ×•××¢×œ×™× ××ª ×”×˜××¤×¨×˜×•×¨×” ×”×××•×¦×¢×ª."},

  {topic:"×ª×¨×‘×•×ª ×•××•×× ×•×ª", region:"×¢×•×œ×", diff:2, term:"×¨× ×¡× ×¡", def:"×ª×§×•×¤×” ×©×œ '×œ×™×“×” ××—×“×©' ×‘××™×¨×•×¤×” ×¢× ×¢× ×™×™×Ÿ ××—×•×“×© ×‘×§×œ××¡×™×§×”, ××“×¢ ×•××•×× ×•×ª."},
  {topic:"×¡×¤×¨×•×ª", region:"×™×©×¨××œ+×¢×•×œ×", diff:2, term:"××˜××¤×•×¨×”", def:"×“×™××•×™ ×œ×-××™×œ×•×œ×™ ×©××¢× ×™×§ ××©××¢×•×ª ×—×“×©×” ('×™× ×©×œ ×“××’×•×ª')."},
  {topic:"×¡×¤×¨×•×ª", region:"×™×©×¨××œ+×¢×•×œ×", diff:3, term:"××¡×¤×¨ ×œ×-××”×™××Ÿ", def:"××¡×¤×¨ ×©×¡×™×¤×•×¨×• ××™× ×• ×‘×”×›×¨×— ×××™×Ÿ; ×”×§×•×¨× ××–×”×” ×¡×ª×™×¨×•×ª/×”×˜×™×•×ª."},

  {topic:"×¡×¤×•×¨×˜", region:"×¢×•×œ×", diff:1, term:"××•×œ×™××¤×™××“×”", def:"×ª×—×¨×•×ª ×¡×¤×•×¨×˜ ×‘×™× ×œ××•××™×ª ×¨×‘-×¢× ×¤×™×ª (×§×™×¥/×—×•×¨×£) ×œ×¤×™ ×›×œ×œ×™× ×¨×©××™×™×."},

  {topic:"×”×™×¡×˜×•×¨×™×”", region:"×¢×•×œ×", diff:1, term:"××œ×—××ª ×”×¢×•×œ× ×”×¨××©×•× ×”", def:"×¢×™××•×ª ×¢×•×œ××™ ×‘×©× ×™× 1914â€“1918 ×‘×™×Ÿ ×‘×¨×™×ª×•×ª ××¢×¦××•×ª."},
  {topic:"×”×™×¡×˜×•×¨×™×”", region:"×¢×•×œ×", diff:1, term:"××œ×—××ª ×”×¢×•×œ× ×”×©× ×™×™×”", def:"×¢×™××•×ª ×¢×•×œ××™ ×‘×©× ×™× 1939â€“1945."},
  {topic:"×”×™×¡×˜×•×¨×™×”", region:"×¢×•×œ×", diff:2, term:"×”××œ×—××” ×”×§×¨×”", def:"×¢×™××•×ª ×’×™××•-×¤×•×œ×™×˜×™ ×‘×™×Ÿ ×’×•×©×™× (××–×¨×—/××¢×¨×‘) ×‘×œ×™ ××œ×—××” ×™×©×™×¨×” ×›×•×œ×œ×ª."},
  {topic:"×”×™×¡×˜×•×¨×™×”", region:"×¢×•×œ×", diff:3, term:"×”×©×¤×œ ×”×’×“×•×œ", def:"××©×‘×¨ ×›×œ×›×œ×™ ×¢×•×œ××™ ×—××•×¨ ×‘×¢×™×§×¨ ×‘×©× ×•×ª ×”-30."},
  {topic:"×”×™×¡×˜×•×¨×™×”", region:"×™×©×¨××œ", diff:1, term:"×”×›×¨×–×ª ×”××“×™× ×” (1948)", def:"×”×›×¨×–×ª ×¢×¦×××•×ª ×™×©×¨××œ ×•×”×§××ª ×”××“×™× ×” ×‘×©× ×ª 1948."},
  {topic:"××™×©×™×", region:"×¢×•×œ×", diff:1, term:"××œ×‘×¨×˜ ××™×™× ×©×˜×™×™×Ÿ", def:"××“×¢×Ÿ ×”××–×•×”×” ×‘××™×•×—×“ ×¢× ×ª×•×¨×ª ×”×™×—×¡×•×ª."},
  {topic:"××™×©×™×", region:"×™×©×¨××œ", diff:2, term:"×“×•×“ ×‘×Ÿ-×’×•×¨×™×•×Ÿ", def:"×¨××© ×”×××©×œ×” ×”×¨××©×•×Ÿ ×©×œ ×™×©×¨××œ ×•×× ×”×™×’ ××¨×›×–×™ ×‘×”×›×¨×–×ª ×”×¢×¦×××•×ª."}
];

const SCENARIOS = [
  {term:"××™× ×¤×œ×¦×™×”", scenario:"×”××—×™×¨×™× ×©×œ ×¨×•×‘ ×”××•×¦×¨×™× ×¢×•×œ×™× ×œ××•×¨×š ×—×•×“×©×™× ×•×›×•×— ×”×§× ×™×™×” ×©×œ ×”×›×¡×£ ×™×•×¨×“."},
  {term:"×¢×œ×•×ª ××œ×˜×¨× ×˜×™×‘×™×ª", scenario:"×›×©×‘×—×¨×ª ×œ×œ××•×“ ×‘××§×•× ×œ×¢×‘×•×“, ×”×•×•×™×ª×•×¨ ×¢×œ ×”×”×›× ×¡×” ×”×•× ×”××—×™×¨ ×©×œ ×”×‘×—×™×¨×”."},
  {term:"××“×™× ×™×•×ª ××•× ×™×˜×¨×™×ª", scenario:"×‘× ×§ ××¨×›×–×™ ××¢×œ×” ×¨×™×‘×™×ª ×›×“×™ ×œ×§×¨×¨ ×‘×™×§×•×©×™× ×•×œ×”×¤×—×™×ª ×œ×—×¥ ××™× ×¤×œ×¦×™×•× ×™."},
  {term:"×”×¤×¨×“×ª ×¨×©×•×™×•×ª", scenario:"×¡××›×•×™×•×ª ××—×•×œ×§×•×ª ×›×“×™ ×©×××©×œ×” ×œ× ×ª×©×œ×•×˜ ×’× ×‘×—×§×™×§×” ×•×’× ×‘××©×¤×˜ ×‘×œ×™ ×¤×™×§×•×—."},
  {term:"×©×œ×˜×•×Ÿ ×”×—×•×§", scenario:"×’× ×”×©×œ×˜×•×Ÿ ×›×¤×•×£ ×œ×›×œ×œ×™× ×•×™×›×•×œ ×œ×¢××•×“ ×œ×“×™×Ÿ ×›××• ×›×œ ××–×¨×—."},
  {term:"×¤×“×¨×œ×™×–×", scenario:"×™×© ×××©×œ ××¨×›×–×™, ××‘×œ ×œ××—×•×–×•×ª/××“×™× ×•×ª ×™×© ×¡××›×•×™×•×ª × ×¤×¨×“×•×ª."},
  {term:"×¤×™×©×™× ×’", scenario:"××™×™×œ ×©× ×¨××” ×›××• ×”×‘× ×§ ×•××‘×§×© ×œ×”×–×™×Ÿ ×¡×™×¡××” â€” × ×™×¡×™×•×Ÿ ×’× ×™×‘×”."},
  {term:"××™××•×ª ×“×•-×©×œ×‘×™ (2FA)", scenario:"××—×¨×™ ×¡×™×¡××” ××ª×§×‘×œ ×§×•×“ × ×•×¡×£ ×‘-SMS/××¤×œ×™×§×¦×™×”."},
  {term:"×”×¨×ª×¢×”", scenario:"××“×™× ×” × ×× ×¢×ª ××ª×§×™×¤×” ×›×™ ×”×™× ×—×•×©×©×ª ××”×ª×’×•×‘×” ×•××”××—×™×¨."},
  {term:"× ×™×¡×•×™ ××‘×•×§×¨", scenario:"×‘×•×“×§×™× ×ª×¨×•×¤×” ××•×œ ×§×‘×•×¦×ª ×‘×™×§×•×¨×ª ×›×“×™ ×œ×•×•×“× ×©×”×”×©×¤×¢×” ×œ× ××§×¨×™×ª."},
  {term:"××¤×§×˜ ×—×××”", scenario:"×’×–×™× ×‘××˜××•×¡×¤×¨×” ×œ×•×›×“×™× ×—×•× ×•××¢×œ×™× ×˜××¤×¨×˜×•×¨×” ×××•×¦×¢×ª."},
];

const TEMPLATES=["DEF_TO_TERM","TERM_TO_DEF","SCENARIO_TERM","COMPARE","APPLY"];

/* Bloom heuristics by template */
function bloomOf(template){
  if(template==="DEF_TO_TERM") return "×–×™×›×¨×•×Ÿ";
  if(template==="TERM_TO_DEF") return "×”×‘× ×”";
  if(template==="SCENARIO_TERM") return "×™×™×©×•×";
  if(template==="APPLY") return "×™×™×©×•×";
  return "× ×™×ª×•×—";
}

/* Build distractor explanations: brief, no heavy claims */
function makeDistractorWhy(correctTerm, optionTerm){
  if(optionTerm===correctTerm) return "×–×• ×”×ª×©×•×‘×” ×”× ×›×•× ×”.";
  return "×–×• ××•×¤×¦×™×” '××¤×ª×”' ×›×™ ×”×™× ×§×©×•×¨×” ×œ××•×ª×• ×ª×—×•×, ××‘×œ ×”×™× ×œ× ××ª××™××” ×œ×”×’×“×¨×”/×ª×¨×—×™×© ×”××“×•×™×§×™× ×‘×©××œ×”.";
}

function makeQuestion(rng, template, concept, pool){
  const topic=concept.topic;
  const bloom=bloomOf(template);
  const baseDiff=concept.diff;

  function optsFromTerms(correct, sameTopic=true){
    const candidates = pool.filter(c => (sameTopic?c.topic===topic:true) && c.term!==correct).map(c=>c.term);
    const distract = shuffle(rng, candidates).slice(0,3);
    const options = shuffle(rng, [correct, ...distract]);
    return {options, answer: options.indexOf(correct)};
  }
  function optsFromDefs(correct, sameTopic=true){
    const candidates = pool.filter(c => (sameTopic?c.topic===topic:true) && c.def!==correct).map(c=>c.def);
    const distract = shuffle(rng, candidates).slice(0,3);
    const options = shuffle(rng, [correct, ...distract]);
    return {options, answer: options.indexOf(correct)};
  }

  if(template==="DEF_TO_TERM"){
    const {options,answer}=optsFromTerms(concept.term,true);
    return {
      id:null, topic, region:concept.region, difficulty: clamp(baseDiff,1,5),
      bloom, conceptTerm: concept.term, template,
      q:"××™×–×” ××•×©×’ ××ª××™× ×œ×”×’×“×¨×” ×”×‘××”?\n" + concept.def,
      options, answer,
      explain:"×”××•×©×’ ×”× ×›×•×Ÿ ×”×•×: " + concept.term + ". " + concept.def,
      why: options.map(o=>makeDistractorWhy(concept.term,o)),
      hint:"(××•×©×’=×©× ×§×¦×¨ ×œ×¨×¢×™×•×Ÿ/×ª×•×¤×¢×”.)",
      updated:"2025-12"
    };
  }

  if(template==="TERM_TO_DEF"){
    const {options,answer}=optsFromDefs(concept.def,true);
    return {
      id:null, topic, region:concept.region, difficulty: clamp(baseDiff+1,1,5),
      bloom, conceptTerm: concept.term, template,
      q:"××” ×”×”×’×“×¨×” ×”××“×•×™×§×ª ×‘×™×•×ª×¨ ×œ:\n" + concept.term,
      options, answer,
      explain:"×”×’×“×¨×” × ×›×•× ×”: " + concept.def,
      why: options.map(o=> (o===concept.def?"×–×• ×”×”×’×“×¨×” ×”××“×•×™×§×ª.":"× ×©××¢ ×“×•××”, ××‘×œ ××™× ×• ××ª××¨ ××ª ×”××•×©×’ ×”×–×” ×‘××•×¤×Ÿ ×”× ×›×•×Ÿ.")),
      hint:"(×”×’×“×¨×”=×”×¡×‘×¨ ×§×¦×¨ ×œ××” ×–×”.)",
      updated:"2025-12"
    };
  }

  if(template==="SCENARIO_TERM"){
    const sc = pick(rng, SCENARIOS);
    const correct = sc.term;
    const anchor = pool.find(c=>c.term===correct) || concept;
    const {options,answer}=optsFromTerms(correct,false);
    return {
      id:null, topic: anchor.topic, region:anchor.region, difficulty: clamp((anchor.diff||3)+1,1,5),
      bloom, conceptTerm: correct, template,
      q:"××™×–×” ××•×©×’ ××ª××¨ ×”×›×™ ×˜×•×‘ ××ª ×”××¦×‘ ×”×‘×?\n" + sc.scenario,
      options, answer,
      explain:"×”××•×©×’ ×”× ×›×•×Ÿ ×”×•×: " + correct + ". " + (anchor.def||""),
      why: options.map(o=>makeDistractorWhy(correct,o)),
      hint:"(×ª×¨×—×™×©=×ª×™××•×¨ ××¦×‘.)",
      updated:"2025-12"
    };
  }

  if(template==="APPLY"){
    // Apply: choose what action best matches concept principle (light, not policy advice)
    const correct = concept.term;
    const {options,answer}=optsFromTerms(correct,true);
    const q =
      "×™×™×©×•× ×§×¦×¨: ××™×–×• ×ª×©×•×‘×” ××©×§×¤×ª ×©×™××•×© × ×›×•×Ÿ ×‘××•×©×’ ×”×‘×?\n" +
      correct + "\n\n" +
      "×‘×—×¨×™ ××ª ×”××•×©×’ ×”××ª××™× ×‘×™×•×ª×¨ (×•××– × ×§×©×¨ ××•×ª×• ×œ×™×™×©×•× ×‘×”×¡×‘×¨).";
    return {
      id:null, topic, region:concept.region, difficulty: clamp(baseDiff+2,1,5),
      bloom, conceptTerm: correct, template,
      q, options, answer,
      explain:"××¤×ª×— ×”×™×™×©×•×: " + correct + " â€” " + concept.def,
      why: options.map(o=>makeDistractorWhy(correct,o)),
      hint:"(×™×™×©×•×=×œ×”×‘×™×Ÿ ××™×š ×”×¨×¢×™×•×Ÿ ×¢×•×‘×“ ×‘××¦×™××•×ª.)",
      updated:"2025-12"
    };
  }

  // COMPARE (analysis)
  const a = concept;
  const b = pick(rng, pool.filter(x=>x.topic===topic && x.term!==a.term)) || concept;
  const correct = a.term;
  const {options,answer}=optsFromTerms(correct,true);
  return {
    id:null, topic, region:a.region, difficulty: clamp(Math.max(a.diff,b.diff)+2,1,5),
    bloom, conceptTerm: a.term, template,
    q:"× ×™×ª×•×— ×§×¦×¨: ××™×–×” ××•×©×’ ××ª××™× ×™×•×ª×¨ ×œ×”×’×“×¨×” ×”×‘××”, ×‘×”×©×•×•××” ×œÖ¾" + b.term + "?\n" + a.def,
    options, answer,
    explain:"×œ××¨×•×ª ×©-" + b.term + " ×™×›×•×œ ×œ×”×™×©××¢ ×§×©×•×¨, ×”×”×’×“×¨×” ×›××Ÿ ×ª×•×××ª ×™×•×ª×¨ ×œ-" + a.term + ". " + a.def,
    why: options.map(o=>makeDistractorWhy(a.term,o)),
    hint:"(× ×™×ª×•×—=×œ×”×‘×—×™×Ÿ ×‘×”×‘×“×œ×™× ×“×§×™×.)",
    updated:"2025-12"
  };
}

function generateBank500(){
  const rng = mulberry32(SEED);
  const pool = CONCEPTS.slice();
  const qs = [];
  let i=0;
  while(qs.length<500){
    const template = TEMPLATES[Math.floor(rng()*TEMPLATES.length)];
    const concept = pool[i % pool.length];
    const q = makeQuestion(rng, template, concept, pool);
    if(!q || !q.options || q.options.length!==4) { i++; continue; }
    q.id = "q_" + String(qs.length+1).padStart(3,"0");
    qs.push(q);
    i++;
  }
  return qs;
}

const BANK = generateBank500();
const BANK_BY_ID = Object.fromEntries(BANK.map(q=>[q.id,q]));

/* =========================================================
   State (Mastery + Spaced + Confidence + Modes)
========================================================= */
let state = loadState() || {
  started:false,
  mode:"mix", // mix | focus | daily
  focusTopics:Object.fromEntries(TOPICS.map(t=>[t,false])),
  daily:{dateKey:null, countToday:0, limit:10},

  answered:0, correct:0, acc:null,
  streak:0,
  dangerCount:0, // high-confidence wrong count
  lastAnswer:null, // store to show why
  current:null,
  lock:false,

  // per-topic mastery
  topicProg:Object.fromEntries(TOPICS.map(t=>[t,{lvl:1,xp:0,streakInTopic:0,attempts:0,correct:0, mastery:false}])),

  // spaced repetition per item (SM-2-lite)
  sr:{}, // qid -> {ease, intervalDays, dueAt, lapses, flagged}
  // keep a small log
  history:[], // {t, ok, conf, topic, qid}
};

/* Initialize SR defaults lazily */
function getSR(qid){
  state.sr[qid] = state.sr[qid] || {ease:2.4, intervalDays:0, dueAt:0, lapses:0, flagged:false, lastConf:0, lastOk:null};
  return state.sr[qid];
}

/* =========================================================
   Modes UI (chips)
========================================================= */
function setMode(mode){
  state.mode=mode;
  $("modeMix").classList.toggle("on",mode==="mix");
  $("modeFocus").classList.toggle("on",mode==="focus");
  $("modeDaily").classList.toggle("on",mode==="daily");
  $("topicChooser").style.display = (mode==="focus") ? "block" : "none";
  saveState();
}
$("modeMix").onclick=()=>setMode("mix");
$("modeFocus").onclick=()=>setMode("focus");
$("modeDaily").onclick=()=>setMode("daily");

/* Build topic chips for focus */
function buildTopicChips(){
  const box=$("topicChips"); box.innerHTML="";
  TOPICS.forEach(t=>{
    const d=document.createElement("div");
    d.className="chip" + (state.focusTopics[t]?" on":"");
    d.textContent=t;
    d.onclick=()=>{
      state.focusTopics[t]=!state.focusTopics[t];
      d.classList.toggle("on", state.focusTopics[t]);
      saveState();
    };
    box.appendChild(d);
  });
}
buildTopicChips();
setMode(state.mode || "mix");

/* =========================================================
   Mastery logic (per topic)
   - Hard gradual selection within each topic band based on lvl
   - Level up only when:
     xp>=100 AND streakInTopic>=needStreak AND topicAcc>=minAcc AND attempts>=minAttempts
========================================================= */
function getTopicProg(topic){
  return state.topicProg[topic] || (state.topicProg[topic]={lvl:1,xp:0,streakInTopic:0,attempts:0,correct:0,mastery:false});
}
function topicRules(lvl){
  if(lvl<=1) return {needStreak:3, minAcc:0.60, minAttempts:10};
  if(lvl===2) return {needStreak:4, minAcc:0.65, minAttempts:14};
  if(lvl===3) return {needStreak:5, minAcc:0.70, minAttempts:18};
  if(lvl===4) return {needStreak:6, minAcc:0.75, minAttempts:22};
  return {needStreak:999, minAcc:0.80, minAttempts:28};
}
function updateTopicProgress(topic, ok, qDifficulty){
  const tp=getTopicProg(topic);
  tp.attempts += 1;
  if(ok) tp.correct += 1;
  const acc = tp.correct / tp.attempts;

  tp.xp += ok ? (10 + qDifficulty*4) : 2;
  tp.xp = clamp(tp.xp, 0, 120);
  tp.streakInTopic = ok ? (tp.streakInTopic+1) : 0;

  // Mastery flag when level 5 and accuracy decent
  tp.mastery = (tp.lvl>=5 && tp.attempts>=28 && acc>=0.80);

  if(tp.lvl<5 && tp.xp>=100){
    const r = topicRules(tp.lvl);
    if(tp.streakInTopic>=r.needStreak && acc>=r.minAcc && tp.attempts>=r.minAttempts){
      tp.lvl += 1;
      tp.xp = 0;
      tp.streakInTopic = 0;
      toast(`×¨××” ×¢×œ×ª×” ×‘× ×•×©× "${topic}" âœ ${tp.lvl}/5`);
    } else {
      tp.xp = 92; // hold near threshold
      toast("×›××¢×˜! ×¢×•×“ ×§×¦×ª ×‘×ª×•×š ×”× ×•×©× ğŸ™‚");
    }
  }

  state.topicProg[topic]=tp;
  return tp;
}
function bandForLvl(lvl){
  if(lvl<=1) return [1,2];
  if(lvl===2) return [2,3];
  if(lvl===3) return [3,4];
  if(lvl===4) return [4,5];
  return [4,5];
}

/* =========================================================
   Spaced Repetition (SM-2-lite)
   - dueAt stored per q
   - selection prefers due items first
   - confidence wrong => higher priority (danger)
========================================================= */
function scheduleSR(qid, ok, conf){
  const sr=getSR(qid);
  sr.lastConf = conf||0;
  sr.lastOk = ok;

  if(!ok){
    sr.lapses += 1;
    sr.intervalDays = 0;
    sr.ease = clamp(sr.ease - (conf>=3?0.25:0.15), 1.3, 2.8);
    // quick retry if wrong; confidence high => even quicker
    const mins = conf>=3 ? 3 : 8;
    sr.dueAt = now() + mins*60*1000;
  } else {
    // correct: expand interval
    if(sr.intervalDays===0) sr.intervalDays = 1;
    else sr.intervalDays = Math.round(sr.intervalDays * sr.ease);

    // adjust ease slightly
    sr.ease = clamp(sr.ease + (conf>=3?0.05:0.02), 1.3, 2.8);

    // due in days (but allow short if early learning)
    const ms = sr.intervalDays * 24*60*60*1000;
    sr.dueAt = now() + ms;
  }
  state.sr[qid]=sr;
}

/* =========================================================
   Topic stats + badges
========================================================= */
function topicStats(){
  const out = {};
  TOPICS.forEach(t=>out[t]={attempts:0,correct:0,score:0,badge:"New"});
  TOPICS.forEach(t=>{
    const tp=getTopicProg(t);
    out[t].attempts = tp.attempts;
    out[t].correct = tp.correct;
    const acc = tp.attempts ? (tp.correct/tp.attempts) : 0.35;
    // smooth score: accuracy + depth
    const depth = clamp(Math.sqrt(tp.attempts/20),0,1);
    out[t].score = clamp(acc*0.75 + depth*0.25,0,1);
    out[t].badge = badgeFor(out[t].score, tp.attempts, tp.lvl);
  });
  return out;
}
function badgeFor(score, attempts, lvl){
  if(attempts<5) return "New";
  if(lvl>=5 && score>=0.82) return "Platinum";
  if(score>=0.80) return "Gold";
  if(score>=0.68) return "Silver";
  return "Bronze";
}
function badgeTone(b){
  if(b==="Platinum") return "rgba(37,99,235,.85)";
  if(b==="Gold") return "rgba(217,119,6,.75)";
  if(b==="Silver") return "rgba(2,6,23,.40)";
  if(b==="Bronze") return "rgba(225,29,72,.55)";
  return "rgba(37,99,235,.75)";
}

/* =========================================================
   Selection: due SR first, then gradual by topic mastery
========================================================= */
function enabledTopics(){
  if(state.mode==="focus"){
    const chosen = TOPICS.filter(t=>state.focusTopics[t]);
    return chosen.length ? chosen : TOPICS; // fallback if none selected
  }
  return TOPICS;
}
function dailyKey(){
  const d=new Date();
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function ensureDailyCounter(){
  const key=dailyKey();
  if(state.daily.dateKey!==key){
    state.daily.dateKey=key;
    state.daily.countToday=0;
  }
}
function pickDueItem(topicsAllowed){
  const t=now();
  const due = [];
  for(const [qid,sr] of Object.entries(state.sr)){
    if(sr.dueAt && sr.dueAt<=t){
      const q = BANK_BY_ID[qid];
      if(!q) continue;
      if(!topicsAllowed.includes(q.topic)) continue;
      // priority: danger wrong first
      const dangerBoost = (sr.lastOk===false && sr.lastConf>=3) ? 2.0 : 1.0;
      const w = dangerBoost * (1 + (sr.lapses||0)*0.2);
      due.push({q,w});
    }
  }
  if(!due.length) return null;
  const total = due.reduce((s,x)=>s+x.w,0);
  let r = Math.random()*total;
  for(const x of due){ r-=x.w; if(r<=0) return x.q; }
  return due[due.length-1].q;
}
function pickTopicWeighted(topicsAllowed){
  const stats=topicStats();
  const weights = topicsAllowed.map(t=>{
    const tp=getTopicProg(t);
    const weakness = 1.15 - stats[t].score;     // weaker => more weight
    const lvlBias  = 1.25 - (tp.lvl-1)*0.10;    // lower lvl => more weight
    const explore  = 1.15 / Math.sqrt(Math.max(1,tp.attempts));
    const w = clamp(weakness*lvlBias*explore, 0.25, 2.8);
    return {t,w};
  });
  const total=weights.reduce((s,x)=>s+x.w,0);
  let r=Math.random()*total;
  for(const x of weights){ r-=x.w; if(r<=0) return x.t; }
  return weights[weights.length-1].t;
}
function pickFromTopic(topic){
  const tp=getTopicProg(topic);
  const [lo,hi]=bandForLvl(tp.lvl);
  const pool = BANK.filter(q=>q.topic===topic && (q.difficulty||3)>=lo && (q.difficulty||3)<=hi);
  const all  = BANK.filter(q=>q.topic===topic);
  const candidates = pool.length?pool:all;

  // weight unseen & prior wrong & flagged
  const scored = candidates.map(q=>{
    const sr=getSR(q.id);
    const unseen = (state.history.find(h=>h.qid===q.id) ? 1.0 : 1.35);
    const lapses = 1 + (sr.lapses||0)*0.35;
    const flagged= sr.flagged ? 1.25 : 1.0;
    const fit = 1/(1+Math.abs((q.difficulty||3) - clamp(tp.lvl+0.2,1,5)));
    return {q, w: unseen*lapses*flagged*fit};
  });
  const total=scored.reduce((s,x)=>s+x.w,0);
  let r=Math.random()*total;
  for(const x of scored){ r-=x.w; if(r<=0) return x.q; }
  return scored[scored.length-1].q;
}
function pickQuestion(){
  const topicsAllowed = enabledTopics();

  if(state.mode==="daily"){
    ensureDailyCounter();
    if(state.daily.countToday>=state.daily.limit){
      return {id:"daily_done", topic:"", region:"", difficulty:1, bloom:"", conceptTerm:"",
        q:"×¡×™×™××ª ××ª ×”-Daily ×”×™×•× ğŸ‰\n×¨×•×¦×” ×œ×”××©×™×š? ×”×—×œ×™×¤×™ ××¦×‘ ×œ-Mix/Focus ×‘××¡×š ×”×¨××©×™.",
        options:["××•×§×™×™","××•×§×™×™","××•×§×™×™","××•×§×™×™"], answer:0,
        explain:"", why:["","","",""], hint:"", updated:""
      };
    }
  }

  // 1) Prefer due spaced items (within allowed topics)
  const due = pickDueItem(topicsAllowed);
  if(due) return due;

  // 2) Otherwise pick topic and then gradual question in that topic
  const t = pickTopicWeighted(topicsAllowed);
  return pickFromTopic(t);
}

/* =========================================================
   Micro-Retest after wrong
   - Immediate corrective question, anchored to same conceptTerm
========================================================= */
function makeMicroRetest(originalQ){
  const term = originalQ.conceptTerm;
  if(!term) return null;
  const concept = CONCEPTS.find(c=>c.term===term);
  if(!concept) return null;
  const rng = mulberry32(SEED + parseInt(originalQ.id.replace("q_",""),10) + 999);

  // alternate template from the original to force retrieval in a different direction
  const alt = (originalQ.template==="DEF_TO_TERM") ? "TERM_TO_DEF" : "DEF_TO_TERM";
  const q = makeQuestion(rng, alt, concept, CONCEPTS.slice());
  q.id = originalQ.id + "_R";
  q.topic = concept.topic;
  q.region= concept.region;
  q.difficulty = clamp((originalQ.difficulty||3),1,5);
  q.bloom = "×”×‘× ×”";
  q.q = "×ª×™×§×•×Ÿ ××™×™×“×™ (Micro-Retest):\n" + q.q;
  q.isRetest = true;
  return q;
}

/* =========================================================
   Overall score
========================================================= */
function calcOverall(){
  const answered = state.answered||0;
  const acc = (state.acc==null)?0:(state.acc);
  const depth = clamp(Math.sqrt(answered/80),0,1);
  // small penalty if danger cluster exists (encourages calibration)
  const danger = clamp((state.dangerCount||0)/Math.max(1,answered),0,0.2);
  return clamp((acc*0.68)+(depth*0.32) - danger*0.20, 0, 1);
}

/* =========================================================
   Drawing (circular meters + donut + radar)
========================================================= */
function roundRect(ctx, x, y, w, h, r, fill, stroke){
  r=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

function drawCircularMeter(canvasId, value01, titleBig, subtitle, tone){
  const c=$(canvasId), ctx=c.getContext("2d");
  const w=c.width, h=c.height;
  ctx.clearRect(0,0,w,h);

  ctx.fillStyle="#fff";
  roundRect(ctx, 10, 10, w-20, h-20, 18, true, false);

  const v = clamp(value01,0,1);
  const cx = w*0.22, cy = h*0.55;
  const r  = Math.min(w,h)*0.28;

  ctx.lineWidth = 26;
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ringbg').trim();
  ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.stroke();

  ctx.strokeStyle = tone || getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  ctx.beginPath();
  ctx.arc(cx,cy,r,-Math.PI/2, -Math.PI/2 + v*2*Math.PI);
  ctx.stroke();

  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim();
  ctx.font="900 34px system-ui";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(Math.round(v*100)+"%", cx, cy-6);

  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
  ctx.font="700 14px system-ui";
  ctx.fillText(titleBig, cx, cy+28);

  ctx.textAlign="right"; ctx.textBaseline="alphabetic";
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim();
  ctx.font="900 18px system-ui";
  ctx.fillText(subtitle, w-24, 54);

  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
  ctx.font="600 13px system-ui";
  const lines = [
    "Spaced: ×œ×¤×™ due time",
    "Mastery: ×¨××•×ª ×œ×¤×™ × ×•×©×",
    "Confidence: 1â€“3"
  ];
  lines.forEach((t,i)=>ctx.fillText(t, w-24, 86+i*22));
}

function drawDonut(){
  const c=$("donut"),ctx=c.getContext("2d");
  const w=c.width,h=c.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle="#fff";
  roundRect(ctx,10,10,w-20,h-20,18,true,false);

  const overall = calcOverall();
  const cx=w*0.18, cy=h*0.55, r=Math.min(w,h)*0.30;
  const start=-Math.PI/2, end=start + overall*2*Math.PI;

  ctx.lineWidth=26;
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ringbg').trim();
  ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.stroke();

  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  ctx.beginPath(); ctx.arc(cx,cy,r,start,end); ctx.stroke();

  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim();
  ctx.font="900 34px system-ui";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(Math.round(overall*100)+"%", cx, cy-6);
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
  ctx.font="700 14px system-ui";
  ctx.fillText("Overall ×™×“×¢", cx, cy+28);

  ctx.textAlign="right"; ctx.textBaseline="alphabetic";
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim();
  ctx.font="900 18px system-ui";
  ctx.fillText("×¤×™×¨×•×§ ××”×™×¨", w-24, 54);

  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
  ctx.font="600 14px system-ui";
  const lines=[
    `×“×™×•×§: ${fmtPct(state.acc)}`,
    `× ×¢× ×•: ${state.answered||0}`,
    `××–×•×¨ ×¡×™×›×•×Ÿ: ${state.dangerCount||0}`,
    `×—×–×¨×•×ª due: ${countDue()}`
  ];
  lines.forEach((t,i)=>ctx.fillText(t, w-24, 88+i*22));
}

function drawRadar(){
  const c=$("radar"),ctx=c.getContext("2d");
  const w=c.width,h=c.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle="#fff";
  roundRect(ctx,10,10,w-20,h-20,18,true,false);

  const stats = topicStats();
  const scores = TOPICS.map(t=>stats[t].score);
  const cx=w*0.50, cy=h*0.52;
  const R=Math.min(w,h)*0.36;
  const n=TOPICS.length;

  ctx.strokeStyle="rgba(15,23,42,.10)";
  ctx.lineWidth=2;
  for(let g=1; g<=4; g++){
    const r=R*(g/4);
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const ang = -Math.PI/2 + (i*2*Math.PI/n);
      const x=cx + r*Math.cos(ang);
      const y=cy + r*Math.sin(ang);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath(); ctx.stroke();
  }

  ctx.strokeStyle="rgba(15,23,42,.10)";
  ctx.lineWidth=2;
  for(let i=0;i<n;i++){
    const ang = -Math.PI/2 + (i*2*Math.PI/n);
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx + R*Math.cos(ang), cy + R*Math.sin(ang));
    ctx.stroke();
  }

  ctx.fillStyle="rgba(37,99,235,.10)";
  ctx.strokeStyle="rgba(37,99,235,.60)";
  ctx.lineWidth=3;
  ctx.beginPath();
  for(let i=0;i<n;i++){
    const ang = -Math.PI/2 + (i*2*Math.PI/n);
    const r = R * scores[i];
    const x = cx + r*Math.cos(ang);
    const y = cy + r*Math.sin(ang);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.closePath(); ctx.fill(); ctx.stroke();

  ctx.fillStyle="rgba(15,23,42,.90)";
  ctx.font="700 13px system-ui";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  for(let i=0;i<n;i++){
    const ang = -Math.PI/2 + (i*2*Math.PI/n);
    const x = cx + (R+52)*Math.cos(ang);
    const y = cy + (R+52)*Math.sin(ang);
    const label = TOPICS[i].length>12 ? TOPICS[i].replace(" ×•××“×™× ×”","") : TOPICS[i];
    ctx.fillText(label, x, y);
  }

  // Strength / Weak
  const arr = TOPICS.map(t=>({t,score:stats[t].score, attempts:stats[t].attempts}));
  const eligible = arr.filter(x=>x.attempts>=6);
  const best = eligible.slice().sort((a,b)=>b.score-a.score).slice(0,3);
  const worst= eligible.slice().sort((a,b)=>a.score-b.score).slice(0,3);
  const bestTxt = best.length ? best.map(x=>`â€¢ ${x.t} (${Math.round(x.score*100)}%)`).join("<br>") : "â€”";
  const worstTxt= worst.length? worst.map(x=>`â€¢ ${x.t} (${Math.round(x.score*100)}%)`).join("<br>") : "â€”";
  $("strengthWeak").innerHTML = `<b>×—×–×§×•×ª</b><br>${bestTxt}<br><br><b>×—×œ×©×•×ª</b><br>${worstTxt}`;

  drawBadges(stats);
}

function drawBadges(stats){
  const box=$("badges"); box.innerHTML="";
  TOPICS.forEach(t=>{
    const tp=getTopicProg(t);
    const b=stats[t].badge;
    const score=Math.round(stats[t].score*100);
    const el=document.createElement("div");
    el.className="badge";
    el.innerHTML = `<span class="dot" style="background:${badgeTone(b)};border-color:${badgeTone(b)}33"></span>
      <span class="bname">${escapeHtml(t)}</span> â€” ${escapeHtml(b)} â€¢ ${score}% â€¢ Lvl ${tp.lvl}/5 â€¢ N=${tp.attempts}`;
    box.appendChild(el);
  });
}

function countDue(){
  const t=now();
  let n=0;
  for(const sr of Object.values(state.sr)){
    if(sr.dueAt && sr.dueAt<=t) n++;
  }
  return n;
}

/* =========================================================
   Render stats + current question
========================================================= */
function drawStats(){
  const overall=calcOverall();
  $("overallPill").textContent = Math.round(overall*100)+"%";
  $("accPill").textContent = fmtPct(state.acc);
  $("answeredPill").textContent = state.answered||0;
  $("dangerPill").textContent = state.dangerCount||0;
  $("reviewPill").textContent = countDue();

  $("answeredStat").textContent = state.answered||0;
  $("correctStat").textContent = state.correct||0;
  $("dangerStat").textContent = state.dangerCount||0;

  drawDonut();
  drawRadar();

  const q=state.current;
  if(q && q.id && q.id!=="daily_done"){
    const tp=getTopicProg(q.topic);
    $("topicLvlStat").textContent = `${tp.lvl}/5`;

    // Topic meter value: topic accuracy + depth
    const accT = tp.attempts ? (tp.correct/tp.attempts) : 0;
    const depthT = clamp(Math.sqrt(tp.attempts/20),0,1);
    const valT = clamp(accT*0.75 + depthT*0.25,0,1);

    const stats=topicStats();
    const badge=stats[q.topic]?.badge || "New";
    $("topicLabel").textContent = `${q.topic} â€¢ ×¨××” ${tp.lvl}/5 â€¢ ${badge}`;
    $("overallLabel").textContent = `Overall ${Math.round(overall*100)}%`;

    drawCircularMeter("meterOverall", overall, "Overall", "×ª××•× ×ª ××¦×‘ ×›×œ×œ×™×ª", "rgba(37,99,235,.85)");
    drawCircularMeter("meterTopic", valT, "× ×•×©×", `${Math.round(valT*100)}%`, badgeTone(badge));

    $("xpText").textContent = `Mastery: XP ${Math.round(tp.xp)}/100 â€¢ ×¨×¦×£ ×‘× ×•×©×: ${tp.streakInTopic} â€¢ ×“×™×•×§ ×‘× ×•×©×: ${Math.round(accT*100)}%`;
    $("xpBar").style.width = clamp((tp.xp/100)*100,0,100)+"%";
  } else {
    $("xpText").textContent = "×”×ª×§×“××•×ª ×‘× ×•×©×: â€”";
    $("xpBar").style.width = "0%";
  }

  saveState();
}

function setCurrent(q){
  state.current=q; state.lock=false; saveState();

  // reset feedback UI
  $("feedbackBox").style.display="none";
  $("whyBox").style.display="none";
  $("whyBtn").disabled=true;
  $("confHint").textContent="";
  document.querySelectorAll(".confBtn").forEach(b=>b.classList.remove("on"));

  if(q.id==="daily_done"){
    $("qMeta").innerHTML="";
    $("qText").textContent=q.q;
    const box=$("answers"); box.innerHTML="";
    drawStats();
    return;
  }

  const tp=getTopicProg(q.topic);
  const sr=getSR(q.id);

  const meta = [
    `×ª×—×•×: ${q.topic}`,
    `××–×•×¨: ${q.region}`,
    `Bloom: ${q.bloom}`,
    `×§×•×©×™: ${(q.difficulty||3)}/5`,
    `×¨××” ×‘×ª×—×•×: ${tp.lvl}/5`,
    `#${q.id.replace("q_","")}`,
    (sr.dueAt?`due: ${new Date(sr.dueAt).toLocaleDateString("he-IL")}`:"due: â€”")
  ];
  $("qMeta").innerHTML = meta.map(x=>`<span class="tag">${escapeHtml(x)}</span>`).join("");

  $("qText").textContent=q.q;

  const box=$("answers");
  box.innerHTML="";
  const keys=["1","2","3","4"];
  q.options.forEach((opt,idx)=>{
    const d=document.createElement("div");
    d.className="ans"; d.dataset.idx=idx;
    d.innerHTML=`<div class="key">${keys[idx]}</div><div class="label">${escapeHtml(opt)}</div>`;
    d.onclick=()=>selectAnswer(idx);
    box.appendChild(d);
  });

  drawStats();
}

/* =========================================================
   Answer flow:
   - answer -> show feedback
   - then ask confidence (1-3) and store it
   - schedule spaced repetition based on ok/conf
   - if wrong: micro-retest queued as next question once
========================================================= */
let queuedRetest=null;

function selectAnswer(idx){
  if(!state.current || state.lock) return;
  const q=state.current;
  if(q.id==="daily_done") return;

  state.lock=true;
  const ok = (idx===q.answer);

  // paint options
  const nodes=Array.from(document.querySelectorAll(".ans"));
  nodes.forEach(n=>{
    const i=Number(n.dataset.idx);
    if(i===q.answer) n.classList.add("correct");
    if(i===idx && !ok) n.classList.add("wrong");
    n.style.pointerEvents="none";
  });

  // update global stats (confidence recorded next)
  state.answered += 1;
  if(ok) state.correct += 1;
  state.acc = state.correct/state.answered;
  state.streak = ok ? (state.streak+1) : 0;

  // daily counter
  if(state.mode==="daily"){
    ensureDailyCounter();
    state.daily.countToday += 1;
  }

  // update topic mastery
  updateTopicProgress(q.topic, ok, q.difficulty||3);

  // store last answer for why
  state.lastAnswer = {qid:q.id, chosen:idx, ok};

  // feedback
  const head = ok
    ? `<b style="color:var(--good)">× ×›×•×Ÿ âœ…</b>`
    : `<b style="color:var(--bad)">×œ× ××“×•×™×§ âŒ</b>`;

  $("feedbackText").innerHTML = head + `<div style="margin-top:6px">${escapeHtml(q.explain||"")}</div>`;
  $("feedbackBox").style.display="block";
  $("whyBtn").disabled=false;

  // queue micro-retest if wrong & not already retest
  queuedRetest = null;
  if(!ok && !q.isRetest){
    const rt = makeMicroRetest(q);
    if(rt) queuedRetest = rt;
  }

  // confidence buttons activate now
  $("confHint").textContent = "×‘×—×¨×™ 1â€“3, ×•××– â€œ×©××œ×” ×”×‘××”â€.";
  state.lock=false; // allow confidence selection + next
  saveState();
  drawStats();
}

function setConfidence(c){
  if(!state.lastAnswer) return;
  // mark UI
  document.querySelectorAll(".confBtn").forEach(b=>{
    b.classList.toggle("on", Number(b.dataset.c)===c);
  });

  const q = BANK_BY_ID[state.lastAnswer.qid] || state.current;
  const ok = state.lastAnswer.ok;

  // store history
  state.history.push({t:now(), ok, conf:c, topic:q.topic, qid:q.id});
  if(state.history.length>2500) state.history=state.history.slice(-2500);

  // danger: high confidence wrong
  if(!ok && c>=3){
    state.dangerCount = (state.dangerCount||0) + 1;
    toast("×¡×•××Ÿ ×›'××–×•×¨ ×¡×™×›×•×Ÿ' (×‘×™×˜×—×•×Ÿ ×’×‘×•×” + ×˜×¢×•×ª) â€“ ×™×•×¤×™×¢ ×‘×—×–×¨×•×ª");
  }

  // schedule spaced repetition
  scheduleSR(q.id, ok, c);

  // store to SR
  const sr=getSR(q.id);
  sr.lastConf=c;
  sr.lastOk=ok;

  state.lastAnswer.conf=c;

  saveState();
  drawStats();
}

document.querySelectorAll(".confBtn").forEach(btn=>{
  btn.onclick=()=>setConfidence(Number(btn.dataset.c));
});

/* Why box */
$("whyBtn").onclick=()=>{
  const la=state.lastAnswer;
  if(!la) return;
  const q = BANK_BY_ID[la.qid] || state.current;
  if(!q || !q.why) return;
  const lines = q.options.map((opt,i)=>{
    const mark = (i===q.answer) ? "âœ…" : "â€¢";
    return `${mark} ${opt} â€” ${q.why[i]||""}`;
  });
  $("whyBox").style.display="block";
  $("whyBox").innerHTML = "<b>×”×¡×‘×¨ ××¡×™×—×™× (Distractors)</b><br>" + escapeHtml(lines.join("\n")).replaceAll("\n","<br>");
};

/* Next question */
function nextQuestion(){
  // require confidence after answering (soft enforcement)
  const fbVisible = $("feedbackBox").style.display!=="none";
  if(fbVisible && state.lastAnswer && state.lastAnswer.conf==null){
    toast("×‘×—×¨×™ Confidence (1â€“3) ×œ×¤× ×™ ×©×××©×™×›×™×");
    return;
  }

  // if retest queued, serve it once
  if(queuedRetest){
    const rt=queuedRetest;
    queuedRetest=null;
    setCurrent(rt);
    return;
  }

  const q=pickQuestion();
  setCurrent(q);
}

$("nextBtn").onclick=()=>nextQuestion();

/* Flag for SR */
$("flagBtn").onclick=()=>{
  const q=state.current;
  if(!q || q.id==="daily_done") return;
  const sr=getSR(q.id);
  sr.flagged = !sr.flagged;
  toast(sr.flagged ? "×¡×•××Ÿ ×œ×—×–×¨×”" : "×‘×•×˜×œ ×¡×™××•×Ÿ");
  saveState();
};

/* Skip */
$("skipBtn").onclick=()=>{
  state.streak=0;
  // do NOT count as answered
  // if something is due and skipped, keep it due
  saveState();
  nextQuestion();
};

/* Reset */
$("resetBtn").onclick=()=>{ if(confirm("×œ××¤×¡ ×”×›×œ? ×–×” ×™××—×§ ×”×ª×§×“××•×ª.")) hardReset(); };

/* Start */
$("startBtn").onclick=()=>{
  state.started=true;
  saveState();
  $("screen_intro").style.display="none";
  $("screen_quiz").style.display="block";
  nextQuestion();
};

/* Copy stats */
$("copyStatsBtn").onclick=()=>{
  const stats=topicStats();
  const summary={
    version:VERSION,
    seed:SEED,
    bankSize:500,
    mode:state.mode,
    daily:state.daily,
    answered:state.answered,
    correct:state.correct,
    accuracy:state.acc,
    overall:Math.round(calcOverall()*100),
    dangerCount:state.dangerCount||0,
    dueCount:countDue(),
    topics:Object.fromEntries(TOPICS.map(t=>{
      const tp=getTopicProg(t);
      return [t,{lvl:tp.lvl, attempts:tp.attempts, acc:(tp.attempts?tp.correct/tp.attempts:0), mastery:tp.mastery, badge:stats[t].badge}];
    })),
  };
  const txt=JSON.stringify(summary,null,2);
  navigator.clipboard?.writeText(txt).then(()=>toast("×”×“×•×— ×”×•×¢×ª×§ ×œ×œ×•×—")).catch(()=>toast("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§"));
};

/* Save PNG card */
function saveShareCardPng(){
  const donut=$("donut"), radar=$("radar");
  const overall=Math.round(calcOverall()*100);
  const accTxt=fmtPct(state.acc);
  const answered=state.answered||0;
  const danger=state.dangerCount||0;
  const due=countDue();
  const pad=26, W=1100, H=1550;

  const out=document.createElement("canvas"); out.width=W; out.height=H;
  const ctx=out.getContext("2d");

  ctx.fillStyle="#f6f8fc"; ctx.fillRect(0,0,W,H);
  ctx.fillStyle="#ffffff";
  roundRect(ctx, pad, pad, W-2*pad, H-2*pad, 22, true, false);

  ctx.fillStyle="#0f172a";
  ctx.font="900 28px system-ui";
  ctx.textAlign="right";
  ctx.fillText("×›×¨×˜×™×¡ ×™×“×¢ â€¢ 500 ×©××œ×•×ª", W-pad, pad+36);

  ctx.fillStyle="#475569";
  ctx.font="600 14px system-ui";
  ctx.fillText(`Overall: ${overall}% â€¢ ×“×™×•×§: ${accTxt} â€¢ × ×¢× ×•: ${answered} â€¢ ×¡×™×›×•×Ÿ: ${danger} â€¢ due: ${due}`, W-pad, pad+62);

  ctx.drawImage(donut, pad+20, pad+85, 520, 210);
  ctx.drawImage(radar, pad+20, pad+320, W-2*pad-40, 620);

  ctx.fillStyle="#0f172a";
  ctx.font="800 18px system-ui";
  ctx.fillText("Mastery ×œ×¤×™ ×ª×—×•×", W-pad, pad+1000);

  const stats=topicStats();
  ctx.font="600 14px system-ui";
  ctx.fillStyle="#475569";
  let y=pad+1030;
  const rows=TOPICS.map(t=>{
    const tp=getTopicProg(t);
    const badge=stats[t].badge;
    const acc=tp.attempts?Math.round((tp.correct/tp.attempts)*100):0;
    return `${t}: ${badge} â€¢ Lvl ${tp.lvl}/5 â€¢ Acc ${acc}% â€¢ N=${tp.attempts}`;
  });
  const col1=rows.slice(0,6);
  const col2=rows.slice(6,12);
  const x1=W-pad;
  const x2=W/2 + 40;
  col1.forEach((r,i)=>ctx.fillText(r, x1, y+i*26));
  col2.forEach((r,i)=>ctx.fillText(r, x2, y+i*26));

  ctx.fillStyle="#64748b";
  ctx.font="600 12px system-ui";
  ctx.fillText(`Version: ${VERSION} â€¢ ${new Date().toLocaleString("he-IL")}`, W-pad, H-pad);

  const a=document.createElement("a");
  a.download="×›×¨×˜×™×¡-×™×“×¢.png";
  a.href=out.toDataURL("image/png");
  a.click();
}
$("savePngBtn").onclick=()=>saveShareCardPng();

/* Keyboard */
window.addEventListener("keydown",(e)=>{
  if($("screen_quiz").style.display==="none") return;
  if(!state.current) return;

  if(e.key>="1" && e.key<="4"){
    const idx=Number(e.key)-1;
    const node=document.querySelector(`.ans[data-idx="${idx}"]`);
    if(node && node.style.pointerEvents!=="none") selectAnswer(idx);
  }
  if(e.key.toLowerCase()==="n"){
    nextQuestion();
  }
});

/* On load: if started, jump into quiz */
function boot(){
  if(state.started){
    $("screen_intro").style.display="none";
    $("screen_quiz").style.display="block";
  }
  drawStats();
}
boot();
</script>
</body>
</html>
